Fancy.Mixin("Fancy.store.mixin.Proxy",{pageParam:"page",startParam:"start",limitParam:"limit",sortParam:"sort",directionParam:"dir",keyParam:"key",valueParam:"value",filterParam:"filter",autoLoad:!0,autoSave:!0,saveOrder:["create","update","destroy"],batch:!0,filterOperators:{"<":"lt",">":"gt","<=":"lteq",">=":"gteq","=":"eq","==":"eq","===":"stricteq","!=":"noteq","!==":"notstricteq","":"like","*":"likeor"},initProxy:function(){var a=this;a.proxy=a.data.proxy||{};var b=a.proxy;void 0!==b.autoLoad&&(a.autoLoad=b.autoLoad),void 0!==b.autoSave&&(a.autoSave=b.autoSave),void 0!==b.batch&&(a.batch=b.batch),a.initReader(),a.initWriter(),"rest"===a.proxy.type?a.initRest():(a.initServerAPI(),a.initActionMethods(),a.checkProxy()),a.autoLoad&&a.loadData()},checkProxy:function(){var a=this,b=a.proxy;if(void 0===b.api.read)throw new Error("[FancyGrid Error] - in data proxy there is not url")},checkUrl:function(){var a=this,b=a.proxy;if(void 0===b.url)throw new Error("[FancyGrid Error] - in data proxy there is not url")},initServerAPI:function(){var a=this,b=a.proxy;b.api=b.api||{},b.url&&(b.api.read=b.url),(b.api.update||b.api.read||b.api.create&&b.api.destroy)&&(a.proxyType="server")},initActionMethods:function(){var a=this,b=a.proxy,c=b.methods||{},d=b.method||"GET";c.create=c.create||d,c.read=c.read||d,c.update=c.update||d,c.destroy=c.destroy||d,b.methods=c},loadData:function(){var a,b=this,c=b.proxy,d=b.params||{},e=c.headers||{};b.fire("beforeload"),"server"===b.pageType&&(d[b.pageParam]=b.showPage,d[b.limitParam]=b.pageSize,d[b.startParam]=b.showPage*b.pageSize),b.loading=!0,Fancy.Ajax({url:c.api.read,method:c.methods.read,params:d,dataType:a,getJSON:!0,headers:e,success:function(a){b.loading=!1,b.defineModel(a[b.readerRootProperty]),b.paging?b.processPagingData(a):(b.setData(a[b.readerRootProperty]),b.widget.setSidesHeight()),b.fire("change"),b.fire("load")}})},proxyCRUD:function(a,b,c,d){var e=this;switch(a){case"UPDATE":e.proxyServerUpdate(b,c,d);break;case"DESTROY":e.proxyServerDestroy(b,c);break;case"CREATE":e.proxyServerCreate(b,c)}},proxyServerUpdate:function(a,b,c){var d=this,e=d.params||{},f=d.proxy,g="json"===d.writerType||d.autoSave===!1;g?e=Fancy.isArray(a)&&void 0===b&&void 0===c?a:d.prepareWriterJSONParams(a,b,c):(e.id=a,e[d.keyParam]=b,e[d.valueParam]=c,e.action="update"),d.loading=!0,d.fire("beforeupdate",a,b,c),Fancy.Ajax({url:f.api.update,method:f.methods.update,params:e,sendJSON:g,success:function(e){d.loading=!1,d.fire("update",a,b,c)}})},proxyServerDestroy:function(a,b){var c=this,d=c.params||{},e=c.proxy,f="json"===c.writerType||c.autoSave===!1;f&&Fancy.isArray(a)?d=a:b?d=b:d.id=a,c.loading=!0,c.fire("beforedestroy"),Fancy.Ajax({url:e.api.destroy,method:e.methods.destroy,params:d,sendJSON:f,success:function(b){c.loading=!1,c.fire("destroy",a)}})},proxyServerCreate:function(a,b){var c=this,d=c.params||{},e=c.proxy,f="json"===c.writerType||c.autoSave===!1;f&&Fancy.isArray(a)?d=a:b?d=b:(d.id=a,void 0===d.id&&delete d.id),c.loading=!0,c.fire("beforecreate"),Fancy.Ajax({url:e.api.create,method:e.methods.create,params:d,sendJSON:f,success:function(b){if(c.loading=!1,Fancy.isObject(b.data)&&String(a)!==String(b.data.id))c.changeItemId(a,b.data.id);else if(Fancy.isArray(b.data))for(var d=0,e=a.length;e>d;d++)String(a[d].id)!==String(b.data[d].id)&&c.changeItemId(String(a[d].id),String(b.data[d].id));c.fire("create",b.data)}})},save:function(){for(var a=this,b=a.removed,c=a.changed,d=a.inserted,e=0,f=a.saveOrder.length;f>e;e++)switch(a.saveOrder[e]){case"create":a.saveInsertActions(d);break;case"update":a.saveChangeActions(c);break;case"destroy":a.saveRemoveActions(b)}a.changed={length:0},a.removed={length:0},a.inserted={length:0}},saveChangeActions:function(a){var b=this;if(a.length)if(b.batch){var c=[];for(var d in a)if("length"!==d){var e=a[d],f={id:d};if(b.writeAllFields)f=b.getById(d).data;else for(var g in e)"length"!==g&&(f[g]=e[g].value);c.push(f)}1===c.length?(c=c[0],b.proxyCRUD("UPDATE",c.id,c)):b.proxyCRUD("UPDATE",c)}else for(var d in a)if("length"!==d){var e=a[d],c={};if(b.writeAllFields)c=b.getById(d).data;else for(var g in e)"length"!==g&&(c[g]={id:e.id});b.proxyCRUD("UPDATE",d,c)}},saveRemoveActions:function(a){var b=this;if(0!==a.length)if(b.batch){var c=[];for(var d in a)if("length"!==d){var e=a[d],f={id:d};if(b.writeAllFields)f=b.getById(d).data;else for(var g in e)"length"!==g&&(f={id:e.id});c.push(f)}1===c.length?(c=c[0],b.proxyCRUD("DESTROY",c.id,c)):b.proxyCRUD("DESTROY",c)}else for(var d in a)if("length"!==d){var e=a[d],c={};if(b.writeAllFields)c=e;else for(var g in e)"length"!==g&&(c[g]=e[g].value);b.proxyCRUD("DESTROY",d,c)}},saveInsertActions:function(a){var b=this;if(0!==a.length)if(b.batch){var c=[];for(var d in a)if("length"!==d){var e=a[d],f={id:d};if(b.writeAllFields)f=b.getById(d).data;else for(var g in e.data)f[g]=e[g];c.push(f)}1===c.length?(c=c[0],b.proxyCRUD("CREATE",c.id,c)):b.proxyCRUD("CREATE",c)}else for(var d in a)if("length"!==d){var e=a[d],c={};if(b.writeAllFields)c=e;else for(var g in e)"length"!==g&&(c[g]=e[g].value);b.proxyCRUD("CREATE",d,c)}}}),Fancy.Mixin("Fancy.store.mixin.Rest",{initRest:function(){var a=this;a.proxyType="server",a.checkUrl(),a.initRestServerAPI(),a.initRestActionMethods()},initRestServerAPI:function(){var a=this,b=a.proxy,c=b.url;b.api=b.api||{},b.api.create=c,b.api.read=c,b.api.update=c,b.api.destroy=c},initRestActionMethods:function(){var a=this,b=a.proxy,c=b.methods||{};c.create=c.create||b.method||"POST",c.read=c.read||b.method||"GET",c.update=c.update||b.method||"PUT",c.destroy=c.destroy||b.method||"DELETE",b.methods=c}}),Fancy.Mixin("Fancy.store.mixin.Reader",{readerType:"json",readerRootProperty:"data",initReader:function(){var a=this,b=a.proxy;b.reader&&a.configReader(b.reader)},configReader:function(a){var b=this;switch(Fancy.typeOf(a)){case"string":switch(a){case"json":b.readerType=a;break;default:throw new Error("[FancyGrid Error] - reader "+a+" does not exist")}break;case"object":switch(a.type){case void 0:b.readerType="json";break;case"json":b.readerType=a.type;break;default:throw new Error("[FancyGrid Error] - reader "+a.type+" does not exist")}a.root&&(b.readerRootProperty=a.root)}}}),Fancy.Mixin("Fancy.store.mixin.Writer",{writerType:"string",writeAllFields:!1,initWriter:function(){var a=this,b=a.proxy;b.writer&&a.configWriter(b.writer)},configWriter:function(a){var b=this;switch(a.allFields&&(b.writeAllFields=a.allFields),Fancy.typeOf(a)){case"string":switch(a){case"json":case"string":b.writerType=a;break;default:throw new Error("[FancyGrid Error] - writer "+a.type+" does not exist")}break;case"object":switch(a.type){case void 0:b.writerType="string";break;case"json":case"string":b.writerType=a.type;break;default:throw new Error("[FancyGrid Error] - writer "+a+" does not exist")}a.writeFields&&(b.writeFields=!0),a.root&&(b.writerRootProperty=a.root)}},prepareWriterJSONParams:function(a,b,c){var d=this,e=d.params||{},f={};return f.id=a,d.writeAllFields?Fancy.applyIf(f,d.getById(a).data):void 0===c&&Fancy.isObject(b)?Fancy.applyIf(f,b):void 0===c&&Fancy.isArray(b)?f=b:f[b]=c,d.rootProperty?(e[d.rootProperty]=f,e):f}});