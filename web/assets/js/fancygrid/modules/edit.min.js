Fancy.define("Fancy.grid.plugin.Edit",{extend:Fancy.Plugin,ptype:"grid.edit",inWidgetName:"edit",clicksToEdit:2,tabColumnsSupport:{date:!0,combo:!0,image:!0,number:!0,string:!0,text:!0},constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this,b=a.widget,c=b.store;a.addEvents("tab"),a.Super("init",arguments),b.once("render",function(){a.ons(),c.on("beforeupdate",a.onStoreCRUDBeforeUpdate,a),c.on("update",a.onStoreCRUDUpdate,a),c.on("beforedestroy",a.onStoreCRUDBeforeDestroy,a),c.on("destroy",a.onStoreCRUDDestroy,a),c.on("create",a.onCreate,a)})},ons:function(){var a=this,b=a.widget,c=b.store,d="cell"+a.getClickEventName();b.on("cellclick",a.onClickCell,a),c.on("set",a.onStoreSet,a),a.on("tab",a.onTab,a),b.once("init",function(){b.on(d,a.onClickCellToEdit,a)}),b.on("activate",a.onGridActivate,a),b.on("deactivate",a.onGridDeActivate,a)},onGridActivate:function(){var a=this,b=Fancy.get(document);b.on("keydown",a.onKeyDown,a)},onGridDeActivate:function(){var a=this,b=Fancy.get(document);b.un("keydown",a.onKeyDown,a)},onKeyDown:function(a){var b=this,c=a.keyCode,d=Fancy.key;switch(c){case d.TAB:b.fire("tab",a)}},onTab:function(a,b){var a=this,c=a.widget,d=a.activeCellEditParams;if(d){b.preventDefault();var e=a.getNextCellEditParam();c.celledit&&(c.celledit.hideEditor(),c.tabEdit!==!1&&setTimeout(function(){c.celledit.edit(e)},100))}},getNextCellEditParam:function(){for(var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=(e.rightColumns,e.leftColumns),i=g.columnIndex,j=g.rowIndex,k=g.side,l=e.getBody(k),m=e.getColumns(k),n=m[i+1],o=0,p=20;p>o;o++){var q=d.getNextCellInfo({side:k,columnIndex:i,rowIndex:j});if(k=q.side,i=q.columnIndex,j=q.rowIndex,m=e.getColumns(k),n=m[q.columnIndex],d.tabColumnsSupport[n.type]&&n.editable===!0)break}return l=e.getBody(k),a=l.getCell(j,i).dom,a||(k="center",h.length&&(k="left"),j=0,i=0,l=e.getBody(k),a=l.getCell(j,i).dom),b=n.index||n.key,c=f.getId(j),{id:f.getId(j),side:k,column:n,cell:a,columnIndex:i,rowIndex:j,value:f.get(j,b),data:f.get(j),item:f.getById(c)}},getNextCellInfo:function(a){var b=this,c=b.widget,d=a.side,e=c.getColumns(d),f=a.columnIndex,g=a.rowIndex,h=e[f+1],i=c.rightColumns,j=c.leftColumns;if(h)f++;else switch(d){case"left":d="center",f=0;break;case"center":i.length?(d="right",f=0):j.length?(d="left",f=0,g++):(f=0,g++);break;case"right":j.length?(d="left",f=0,g++):(d="center",f=0,g++)}return{side:d,rowIndex:g,columnIndex:f}},getClickEventName:function(){var a=this;return 1===a.clicksToEdit?"click":2===a.clicksToEdit?"dblclick":void 0},stopEditor:function(){var a=this;a.stopped=!0},onClickCell:function(a,b){var c=this,d=c.widget,e=b.column;e.type;e.editable&&"checkbox"===e.type&&d.celledit&&d.celledit.onCheckBoxChange(b)},onClickCellToEdit:function(a,b){var c=this,d=c.widget,e=b.column;e.type;return d.rowedit||d.celledit&&d.celledit.hideEditor(),c.fire("beforedit"),c.stopped===!0?void(c.stopped=!1):void(d.rowedit?d.rowedit.edit(b):e.editable&&"checkbox"!==e.type&&d.celledit&&d.celledit.edit(b))},onStoreSet:function(a,b){var c=this,d=c.widget;d.updater.updateRow(b.rowIndex)},onStoreCRUDBeforeUpdate:function(){var a,b=this,c=b.widget,d=b.activeCellEditParams;d&&(a=Fancy.get(d.cell),c.updater.updateRow(d.rowIndex))},onStoreCRUDUpdate:function(a,b,c,d){var e,f=this,g=(f.widget,f.activeCellEditParams);g&&(e=Fancy.get(g.cell)),delete a.changed[b],f.clearDirty()},onStoreCRUDBeforeDestroy:function(){},onStoreCRUDDestroy:function(){var a=this,b=a.widget,c=b.store;c.loadData(),a.clearDirty()},clearDirty:function(){var a=this,b=a.widget;b.store;setTimeout(function(){b.leftBody.clearDirty(),b.body.clearDirty(),b.rightBody.clearDirty()},500)},onCreate:function(a,b){var c=this,d=c.widget;d.store;d.updater.update(),c.clearDirty()}}),Fancy.define("Fancy.grid.plugin.CellEdit",{extend:Fancy.Plugin,ptype:"grid.celledit",inWidgetName:"celledit",constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.initEditorContainer(),b.on("scroll",a.onScroll,a),b.on("docclick",a.onDocClick,a),b.on("headercellmousedown",a.onHeaderCellMouseDown,a)})},onDocClick:function(a,b){var c=this,d=c.activeCellEditParams,e=c.activeEditor,f=!0;if(void 0!==e&&"combo"===d.column.type){var g=b.target;e.el.within(g)===!1&&e.list.within(g)===!1&&c.comboClick!==!0&&(f=!1),f===!1&&e.hide(),c.comboClick=!1}},initEditorContainer:function(){var a=this,b=a.widget;a.editorsContainer=b.el.select(".fancy-grid-editors")},edit:function(a){var b=this,c=b.widget,d=a.column;d.type;"$selected"!==d.index&&(b.activeCellEditParams=a,c.edit.activeCellEditParams=a,d.editor=b.generateEditor(d),c.scroller.scrollToCell(a.cell),b.showEditor(a))},generateEditor:function(a){var b,c,d=this,e=d.widget,f={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"},g=a.type,h=a.vtype,i=e.theme;if(a.editor)return a.editor;c=d.editorsContainer.dom;var j={renderTo:c,label:!1,style:f};switch(g){case"combo":var k,l="valueText",m="valueText";void 0!==a.displayKey&&(l=a.displayKey,m=l),k=Fancy.isObject(a.data)||Fancy.isObject(a.data[0])?a.data:d.configComboData(a.data),"default"===i&&(i=void 0),b=new Fancy.Combo({theme:i,renderTo:c,label:!1,style:f,data:k,displayKey:l,valueKey:m,value:0,padding:!1,vtype:h,events:[{change:d.onComboChange,scope:d}]});break;case"text":b=new Fancy.TextArea({renderTo:c,label:!1,style:f,vtype:h,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"image":case"string":b=new Fancy.StringField({renderTo:c,label:!1,style:f,vtype:h,format:a.format,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"number":case"currency":Fancy.apply(j,{vtype:h,format:a.format,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]}),void 0!==a.spin&&(j.spin=a.spin),void 0!==a.step&&(j.step=a.step),void 0!==a.min&&(j.min=a.min),void 0!==a.max&&(j.max=a.max),b=new Fancy.NumberField(j);break;case"date":b=new Fancy.DateField({renderTo:c,label:!1,style:f,format:a.format,lang:e.lang,vtype:h,theme:i,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;default:throw new Error("[FancyGrid error] - type "+g+" editor does not exit")}return b},configComboData:function(a){var b=0,c=a.length,d=[];if(Fancy.isObject(a))return a;for(;c>b;b++)d.push({index:b,valueText:a[b]});return d},showEditor:function(a){var b=this,c=b.widget,d=a.column,e=d.type,f=d.editor,g=a.cell,h=b.getCellPosition(g),i=b.getCellSize(g);"combo"===e&&(b.comboClick=!0),b.activeEditor=f,b.setEditorValue(a),b.setEditorSize(i),f.show(),f.el.css(h),f.focus(),c.fire("startedit",a)},setEditorSize:function(a){var b=this;"field.combo"===b.activeEditor.wtype?b.activeEditor.size(a):b.activeEditor.setInputSize({width:a.width,height:a.height})},hideEditor:function(){var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=d.activeEditor;h&&(c=g.column,b=h.get(),"server"===f.proxyType&&"combo"!==c.type&&(a=d.getActiveColumnKey(),b=d.prepareValue(b),f.set(g.rowIndex,a,b)),h.hide(),h.hideErrorTip()),delete d.activeEditor},getCellPosition:function(a){var b=this,c=b.widget,d=c.gridBorders,e=Fancy.get(a),f=e.offset(),g=c.el.offset(),h={left:parseInt(f.left)-parseInt(g.left)-2+"px",top:parseInt(f.top)-parseInt(g.top)-(d[0]+d[2])+"px"};return h},getCellSize:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.width(),f=d.height(),g=2;return Fancy.nojQuery&&2===c.panelBorderWidth&&(g=1),e+=parseInt(d.css("border-right-width"))*g,f+=parseInt(d.css("border-bottom-width"))*g,{width:e,height:f}},setEditorValue:function(a){var b=this,c=b.widget,d=(c.lang,b.activeEditor);switch(a.column.type){case"combo":-1!==d.valueIndex&&d.set(d.getValueKey(a.value),!1);break;case"date":var e=a.column.format,f=Fancy.Date.parse(a.value,e.read,e.mode);d.set(f);break;default:d.set(a.value)}},onEditorEnter:function(a,b){var c=this;c.hideEditor()},onHeaderCellMouseDown:function(){var a=this;a.hideEditor()},onKey:function(a,b){},setValue:function(a){var b,c=this,d=c.widget,e=d.store,f=c.activeCellEditParams,g=c.activeEditor;void 0!==g&&g.isValid()!==!1&&"server"!==e.proxyType&&(b=c.getActiveColumnKey(),a=c.prepareValue(a),"field.date"===g.type&&g.isEqual(e.get(f.rowIndex,b))||e.set(f.rowIndex,b,a))},onEditorBeforeHide:function(a){var b=this;b.setValue(a.getValue())},onScroll:function(){var a=this;a.hideEditor()},onBlur:function(a){var b=this;if(!b.activeEditor||a.id===b.activeEditor.id){if(a.mouseDownSpinUp===!0||a.mouseDownSpinDown)return;b.hideEditor()}},prepareValue:function(a){var b=this,c=b.getActiveColumnType(),d=b.activeCellEditParams,e=d.column,f=e.format;switch(c){case"number":case"currency":if(f&&f.inputFn){var g="",h=0,i=a.length;if(Fancy.isNumber(a))return a;for(;i>h;h++)isNaN(Number(a[h]))||(g+=a[h]);a=g}else""!==a&&(a=Number(a));break;case"date":if(e.format&&e.format.read){var j=e.editor.getDate();a=Fancy.Date.format(j,e.format.read,void 0,e.format.mode)}}return a},getActiveColumnType:function(){var a=this,b=a.activeCellEditParams,c=b.column;return c.type},getActiveColumnKey:function(){var a=this,b=a.activeCellEditParams,c=b.column,d=c.key||c.index;return d},onCheckBoxChange:function(a){var b=this,c=b.widget,d=a.column,e=d.key||d.index,f=c.store,g=b.checkBoxChangedValue;b.activeEditor&&b.hideEditor(),void 0!==b.checkBoxChangedValue&&(delete b.checkBoxChangedValue,b.activeCellEditParams=a,c.edit.activeCellEditParams=a,f.set(a.rowIndex,e,g))},onComboChange:function(a,b){var c=this,d=c.widget,e=d.store,f=c.activeEditor,g=c.activeCellEditParams,h=c.getActiveColumnKey(),i=f.getDisplayValue(b);-1!==a.valueIndex&&(b=i),e.set(g.rowIndex,h,b),c.hideEditor()}}),Fancy.define("Fancy.grid.plugin.RowEdit",{extend:Fancy.Plugin,ptype:"grid.rowedit",inWidgetName:"rowedit",rendered:!1,constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a),b.grouping&&(b.on("collapse",a.onCollapse,a),b.on("expand",a.onExpand,a))},onCollapse:function(){var a=this;a.hide()},onExpand:function(){var a=this;a.hide()},edit:function(a){var b=this,c=b.widget,d=(c.store,a.column);d.type;"$selected"!==d.index&&(c.scroller.scrollToCell(a.cell),b.showEditor(a))},showEditor:function(a){var b=this;if(b.changed={},b.rendered){var c="none"===b.el.css("display");b.show(),b.changePosition(a.rowIndex,!c)}else b.render(),b.changePosition(a.rowIndex,!1);b.setValues(a),b.setSizes()},render:function(){var a=this,b=a.widget;b.leftColumns&&(a.leftEl=a.renderTo(b.leftBody.el,b.leftColumns)),b.columns&&(a.el=a.renderTo(b.body.el,b.columns)),b.rightColumns&&(a.rightEl=a.renderTo(b.rightBody.el,b.rightColumns)),a.renderButtons(),a.rendered=!0},renderTo:function(a,b){var c,d,e=this,f=e.widget,g=Fancy.get(document.createElement("div")),h=0,i=b.length,j=f.theme,k={"float":"left",margin:"0px",padding:"0px"};for(g.addClass(f.rowEditCls),c=Fancy.get(a.dom.appendChild(g.dom));i>h;h++){d=b[h];var l,m=d.width,n={index:d.index,renderTo:c.dom,label:!1,style:k,width:m,vtype:d.vtype,format:d.format,stopPropagation:!0,theme:j,events:[{change:e.onFieldChange,scope:e},{enter:e.onFieldEnter,scope:e}]};if(d.editable===!1)switch(Fancy.apply(n,{}),d.type){case"string":case"number":l=new Fancy.TextField(n);break;default:l=new Fancy.EmptyField(n)}else switch(d.type){case"date":Fancy.apply(n,{}),d.format&&(n.format=d.format),l=new Fancy.DateField(n);break;case"image":case"string":case"color":Fancy.apply(n,{}),l=new Fancy.StringField(n);break;case"number":Fancy.apply(n,{}),d.spin&&(n.spin=d.spin),d.step&&(n.step=d.step),d.min&&(n.min=d.min),d.max&&(n.max=d.max),l=new Fancy.NumberField(n);break;case"combo":Fancy.apply(n,{data:e.configComboData(d.data),displayKey:"valueText",valueKey:"index",value:0,padding:!1}),l=new Fancy.Combo(n);break;case"checkbox":var o;switch(d.cellAlign){case"left":o=7;break;case"center":o=(d.width-20-2)/2;break;case"right":o=(d.width-20)/2+11}Fancy.apply(n,{renderId:!0,value:!1,style:{padding:"0px",display:"inline-block","padding-left":o,"float":"left",margin:"0px"}}),l=new Fancy.CheckBox(n);break;default:l=new Fancy.EmptyField(n)}d.rowEditor=l}return c},renderButtons:function(){var a,b=this,c=b.widget,d=Fancy.get(document.createElement("div"));d.addClass(c.rowEditButtonCls),a=Fancy.get(c.body.el.dom.appendChild(d.dom)),b.buttonsEl=a,b.buttonUpdate=new Fancy.Button({cls:"fancy-edit-row-button-update",renderTo:a.dom,text:"Update",events:[{click:b.onClickUpdate,scope:b}]}),b.buttonCancel=new Fancy.Button({cls:"fancy-edit-row-button-cancel",renderTo:a.dom,text:"Cancel",events:[{click:b.onClickCancel,scope:b}]})},setSizes:function(){var a=this,b=a.widget;b.leftColumns&&a._setSizes(b.leftBody.el.select('.fancy-grid-cell[index="0"]'),b.leftColumns,"left"),b.columns&&a._setSizes(b.body.el.select('.fancy-grid-cell[index="0"]'),b.columns),b.rightColumns&&a._setSizes(b.rightBody.el.select('.fancy-grid-cell[index="0"]'),b.rightColumns,"right"),a.setElSize()},setElSize:function(){var a=this,b=a.widget,c=b.getCenterViewWidth(),d=b.getCenterFullWidth();d>c&&a.el.css("width",d)},_setSizes:function(a,b,c){for(var d,e,f,g,h,i=this,j=0,k=b.length,l=1,m=2;k>j;j++)d=b[j],f=a.item(j).dom,g=Fancy.get(f),e=i.getCellSize(f),h=d.rowEditor,h&&("left"!==c&&"right"!==c||j!==k-1||e.width--,e.height-=2,j===k-1?h.el.css("width",e.width-2):h.el.css("width",e.width-1),h.el.css("height",e.height),e.width-=2*l,e.width-=2*m,e.height-=2*m,i.setEditorSize(h,e))},getCellSize:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.width(),f=d.height(),g=2;return Fancy.nojQuery&&2===c.panelBorderWidth&&(g=1),e+=parseInt(d.css("border-right-width"))*g,f+=parseInt(d.css("border-bottom-width"))*g,{width:e,height:f}},setEditorSize:function(a,b){"field.combo"===a.wtype?(a.size(b),a.el.css("width",b.width+5)):a.setInputSize({width:b.width,height:b.height})},changePosition:function(a,b){var c=this,d=c.widget,e=d.scroller.getScroll(),f=d.scroller.getBottomScroll(),g=d.cellHeight*a-1-e,h=100,i=0;d.grouping&&(i+=d.grouping.getOffsetForRow(a),g+=i),c.leftEl&&(b!==!1?c.leftEl.animate({duration:h,top:g}):c.leftEl.css("top",g)),c.el&&(b!==!1?c.el.animate({duration:h,top:g}):c.el.css("top",g)),c.rightEl&&(b!==!1?c.rightEl.animate({duration:h,top:g}):c.rightEl.css("top",g));var j=d.getViewTotal()-3<a,k=g;3>a&&(j=!1),j?d.grouping?d.getViewTotal()-3<a-d.grouping.getSpecialRowsUnder(a)?k=g-parseInt(c.buttonsEl.css("height"))+1:(k=g+d.cellHeight,j=!1):k=g-parseInt(c.buttonsEl.css("height"))+1:k=g+d.cellHeight,b!==!1?c.buttonsEl.animate({duration:h,top:k}):c.buttonsEl.css("top",k),c.el.css("left",-f),c.changeButtonsLeftPos(),c.activeRowIndex=a},changeButtonsLeftPos:function(){var a=this,b=a.widget,c=b.getCenterViewWidth(),d=parseInt(a.buttonsEl.css("width"));a.buttonsEl.css("left",(c-d)/2)},setValues:function(a){var b=this,c=b.widget;c.leftColumns&&b._setValues(a.data,c.leftColumns),c.columns&&b._setValues(a.data,c.columns),c.rightColumns&&b._setValues(a.data,c.rightColumns),b.activeId=a.id},_setValues:function(a,b){for(var c,d,e=0,f=b.length;f>e;e++)if(c=b[e],d=c.rowEditor)switch(c.type){case"action":case"button":case"order":case"select":break;default:d.set(a[c.index],!1)}},onScroll:function(){var a=this;a.widget;a.rendered!==!1&&void 0!==a.activeRowIndex&&a.changePosition(a.activeRowIndex,!1)},onColumnResize:function(){var a=this;a.widget;a.rendered!==!1&&a.setSizes()},onClickUpdate:function(){var a=this,b=a.widget,c=b.store,d=a.prepareChanged(),e=c.getRow(a.activeId);c.setItemData(e,d),b.update(),a.hide()},prepareChanged:function(){var a=this,b=a.widget,c=a.changed;for(var d in c){var e=b.getColumnByIndex(d);switch(e.type){case"date":var f=Fancy.Date.parse(c[d],e.format.edit),g=Fancy.Date.format(f,e.format.read);c[d]=g}}return c},onClickCancel:function(){var a=this;a.hide()},hide:function(){var a=this;a.el&&(a.leftEl&&a.leftEl.hide(),a.el.hide(),a.rightEl&&a.rightEl.hide(),a.buttonsEl.hide())},show:function(){var a=this;a.leftEl&&a.leftEl.show(),a.el.show(),a.rightEl&&a.rightEl.show(),a.buttonsEl.show()},onFieldChange:function(a,b,c){var d=this;d.changed[a.index]=b},configComboData:function(a){var b=0,c=a.length,d=[];if(Fancy.isObject(a))return a;for(;c>b;b++)d.push({index:a[b],valueText:a[b]});return d},onFieldEnter:function(){var a=this,b=a.widget,c=b.store,d=c.getRow(a.activeId);c.setItemData(d,a.changed),b.update(),a.hide()}});