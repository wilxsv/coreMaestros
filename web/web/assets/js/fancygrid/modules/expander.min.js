Fancy.define("Fancy.grid.plugin.Expander",{extend:Fancy.Plugin,ptype:"grid.expander",inWidgetName:"expander",plusScroll:0,constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a._expanded={},a._expandedIds={},a.initTpl(),a.ons()},initTpl:function(){var a=this;a.tpl&&(a.tpl=new Fancy.Template(a.tpl))},ons:function(){var a=this,b=a.widget;b.store;b.on("scroll",a.onScroll,a),b.on("sort",a.onSort,a),b.on("columnresize",a.onColumnReSize,a),b.on("rowdblclick",a.onRowDBlClick,a),b.on("rowtrackenter",a.onRowTrackOver,a),b.on("rowtrackleave",a.onRowTrackLeave,a),b.on("render",function(){b.el.on("mouseenter",a.onExpandRowMouseEnter,a,"div.fancy-grid-expand-row"),b.el.on("mouseleave",a.onExpandRowMouseLeave,a,"div.fancy-grid-expand-row")}),b.on("select",a.onSelect,a),b.on("clearselect",a.onClearSelect,a)},expand:function(a){var b=this,c=b.widget,d=c.get(a).id;void 0===b._expandedIds[d]?(b._expandedIds[d]={},b.expandRow(Number(a),d),b.addMargin(Number(a)+1,d)):b.showRow(Number(a),d),delete b._expandedIds[d].hidden,b.reSetTop(),b.reSetPlusScroll();for(var e=c.el.select('.fancy-grid-column[grid="'+c.id+'"] .fancy-grid-cell[index="'+a+'"] .fancy-checkbox-expander'),f=0,g=e.length;g>f;f++){var h=Fancy.getWidget(e.item(f).attr("id"));h.get()===!1&&h.set(!0,!1)}b.changeSidesSize(),b.onSelect()},collapse:function(a){var b=this,c=b.widget,d=c.scroller,e=c.get(a).id;b.collapseRow(Number(a),e),b.clearMargin(Number(a)+1,e),b.reSetTop(),b.reSetPlusScroll(),b.changeSidesSize(),d.scrollDelta(1),d.scrollRightKnob()},collapseRow:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b];e.el.hide(),e.hidden=!0,d.leftColumns&&e.leftEl.hide(),d.rightColumns&&e.rightEl.hide();for(var f=d.el.select('.fancy-grid-column[grid="'+d.id+'"] .fancy-grid-cell[index="'+a+'"] .fancy-checkbox-expander'),g=0,h=f.length;h>g;g++){var i=Fancy.getWidget(f.item(g).attr("id"));i.get()===!0&&i.set(!1,!1)}},expandRow:function(a,b){var c,d,e=this,f=e.widget,g=Fancy.get(document.createElement("div")),h=f.getById(b),i=e.prepareData(h),j=-f.scroller.scrollLeft||0,k=f.getCenterFullWidth();e.tpl&&(c=e.tpl.getHTML(i),g.update(c)),g.addClass("fancy-grid-expand-row"),g.css("left",j+"px"),g.css("width",k+"px"),g.attr("index",a);f.body.el.dom.appendChild(g.dom);if(e.render&&e.render(g.dom,i,f.getCenterFullWidth()),d=parseInt(g.css("height")),e._expandedIds[b].rowIndex=a,e._expandedIds[b].el=g,e._expandedIds[b].height=d,e._expandedIds[b].width=k,f.leftColumns){var l=Fancy.get(document.createElement("div"));l.css("left","0px"),l.css("height",d),l.css("width",f.getLeftFullWidth()),l.attr("index",a),l.addClass("fancy-grid-expand-row"),f.leftBody.el.dom.appendChild(l.dom),e._expandedIds[b].leftEl=l}if(f.rightColumns){var m=Fancy.get(document.createElement("div"));m.css("left","0px"),m.css("height",d),m.css("width",f.getLeftFullWidth()),m.attr("index",a),m.addClass("fancy-grid-expand-row"),f.rightBody.el.dom.appendChild(m.dom),e._expandedIds[b].rightEl=m}},addMargin:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b].height,f=d.el.select('.fancy-grid-column[grid="'+d.id+'"] .fancy-grid-cell[index="'+a+'"]');f.css("margin-top",e)},clearMargin:function(a,b){var c=this,d=c.widget;c._expandedIds[b].height;d.el.select('.fancy-grid-column[grid="'+d.id+'"] .fancy-grid-cell[index="'+a+'"]').css("margin-top","0")},onScroll:function(){var a=this,b=a.widget,c=-b.scroller.scrollTop||0,d=-b.scroller.scrollLeft||0,e=b.cellHeight;for(var f in a._expandedIds){var g=a._expandedIds[f],h=a.getBeforeHeight(g.rowIndex),i=c+(g.rowIndex+1)*e+h;g.el.css("top",i),b.leftColumns&&g.leftEl.css("top",i),b.rightColumns&&g.rightEl.css("top",i),g.el.css("left",d)}},onSort:function(){var a=this;a.widget;for(var b in a._expandedIds){var c=a._expandedIds[b];c.el.destroy(),a.clearMargin(Number(c.rowIndex)+1,b)}a._expandedIds={}},showRow:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b];e.el.show(),d.leftColumns&&e.leftEl.show(),d.rightColumns&&e.rightEl.show(),c.addMargin(a+1,b)},getBeforeHeight:function(a){var b=this,c=0;for(var d in b._expandedIds){var e=b._expandedIds[d];e.rowIndex<a&&!e.hidden&&(c+=e.height)}return c},reSetTop:function(){var a=this,b=a.widget,c=b.cellHeight,d=-b.scroller.scrollTop||0,e=-b.scroller.scrollLeft||0;for(var f in a._expandedIds){var g=a._expandedIds[f],h=a.getBeforeHeight(g.rowIndex),i=d+(g.rowIndex+1)*c+h;g.el.css("top",i),g.el.css("left",e),b.leftColumns&&g.leftEl.css("top",i),b.rightColumns&&g.rightEl.css("top",i)}},reSetPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.getPlusHeight(),b.scroller.setRightKnobSize()},getPlusHeight:function(){var a=this,b=(a.widget,0);for(var c in a._expandedIds){var d=a._expandedIds[c];d.hidden||(b+=d.height)}return a.plusHeight=b,a.plusHeight},onColumnReSize:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c],e=b.getCenterFullWidth();d.el.css("width",e)}},prepareData:function(a){var b=this,c=b.widget,d=a.data;return b.dataFn&&(d=b.dataFn(c,d)),d},changeSidesSize:function(){var a=this,b=a.widget;b.scroller;b.setSidesHeight(),b.scroller.checkRightScroll()},onRowDBlClick:function(a,b){var c=this,d=c.widget,e=Number(b.rowIndex),f=b.id,g=c._expandedIds[f];return d.edit?void d.un("rowdblclick",c.onRowDBlClick,c):void(void 0===g?c.expand(e):g.hidden===!0?c.expand(e):c.collapse(e))},onRowTrackOver:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.addClass(d.expandRowOverCls),d.leftColumns&&e.leftEl.addClass(d.expandRowOverCls),d.rightColumns&&e.rightEl.addClass(d.expandRowOverCls))},onRowTrackLeave:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.removeClass(d.expandRowOverCls),d.leftColumns&&e.leftEl.removeClass(d.expandRowOverCls),d.rightColumns&&e.rightEl.removeClass(d.expandRowOverCls))},onExpandRowMouseEnter:function(a){var b=this,c=b.widget,d=c.scroller,e=Fancy.get(a.currentTarget),f=e.attr("index");c.el.select('.fancy-grid-expand-row[index="'+f+'"]').addClass(c.expandRowOverCls),!c.trackOver||d.bottomKnobDown||d.rightKnobDown||c.el.select('.fancy-grid-column[grid="'+c.id+'"] .fancy-grid-cell[index="'+f+'"]').addClass(c.rowOverCls)},onExpandRowMouseLeave:function(a){var b=this,c=b.widget,d=c.scroller,e=Fancy.get(a.currentTarget),f=e.attr("index");c.el.select('.fancy-grid-expand-row[index="'+f+'"]').removeClass(c.expandRowOverCls),!c.trackOver||d.bottomKnobDown||d.rightKnobDown||c.el.select('.fancy-grid-column[grid="'+c.id+'"] .fancy-grid-cell[index="'+f+'"]').removeClass(c.rowOverCls)},onSelect:function(){var a=this,b=a.widget,c=b.selection;if(c.row||c.rows){a.onClearSelect(),c=b.getSelection(!0);for(var d=c.rows,e=0,f=d.length;f>e;e++){var g=d[e];b.el.select('.fancy-grid-expand-row[index="'+g+'"]').addClass(b.expandRowSelectedCls)}}},onClearSelect:function(){var a=this,b=a.widget,c=b.selection;if(c.row||c.rows){c=b.getSelection(!0);for(var d={},e=c.rows,f=0,g=e.length;g>f;f++)d[e[f]]=!0;for(var h=b.el.select(".fancy-grid-expand-row-selected"),f=0,g=h.length;g>f;f++){var i=h.item(f).attr("index");d[i]||b.el.select('.fancy-grid-expand-row[index="'+i+'"]').removeClass(b.expandRowSelectedCls)}}}});